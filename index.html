<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-orientations" content="portrait">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-color" content="#000000">
    <title>Duck Siders</title>
    <style>
        /* ... (все стили остаются без изменений до #gameCanvas) ... */
        
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: #87CEEB;
            touch-action: none;
        }
        
        /* Добавляем это для правильного масштабирования игрового интерфейса */
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }
        
        .ui-element {
            position: absolute;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        /* ... (остальные стили остаются без изменений) ... */
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="telegram-info" id="telegramInfo" style="display: none;"></div>
        <canvas id="gameCanvas"></canvas>
        
        <!-- Экран лобби -->
        <div id="lobbyScreen" class="screen">
            <div class="lobby-content">
                <!-- Статистика -->
                <div class="lobby-stats">
                    <div class="stat-container">
                        <img src="images/CoinScore.png" alt="Монеты" class="stat-image">
                        <div class="stat-value" id="totalCoins">0</div>
                    </div>
                    <div class="stat-container">
                        <img src="images/RecordScore.png" alt="Рекорд" class="stat-image">
                        <div class="stat-value" id="totalScore">0</div>
                    </div>
                    <div class="stat-container">
                        <img src="images/EmeraldScore.png" alt="Алмазы" class="stat-image">
                        <div class="stat-value" id="totalDiamonds">0</div>
                    </div>
                </div>
                
                <!-- Птица -->
                <img id="lobbyDuck" src="images/ClassicDuckSkin.png" alt="Duck">
                
                <!-- Кнопка старта -->
                <button class="start-button" id="lobbyStartButton">
                    <img src="images/StartBottom.png" alt="Начать игру" class="start-button-image">
                </button>
            </div>
        </div>
        
        <div id="readyScreen" class="screen">
            <div class="ready-text blink">
                <div>НАЖМИТЕ</div>
                <div>чтобы начать игру</div>
            </div>
        </div>
        
        <div id="gameOverScreen" class="screen">
            <h1>Марина красотка</h1>
            <div class="finalScore">Счет: <span id="finalScore">0</span></div>
            <div class="finalScore">Монетки: <span id="finalCoins">0</span></div>
            <div class="finalScore">Алмазы: <span id="finalDiamonds">0</span></div>
            <div id="highScoreDisplay" class="finalScore" style="display: none;">Рекорд: <span id="highScoreValue">0</span></div>
            <button id="restartButton">Играть снова</button>
            <button id="toLobbyButton" style="background: #4444ff; color: white; margin-top: 10px;">В лобби</button>
        </div>
    </div>

    <script>
        // Telegram Mini App интеграция
        function initTelegramIntegration() {
            // ... (остается без изменений) ...
        }
        
        // Инициализируем Telegram интеграцию сразу
        const telegram = initTelegramIntegration();
        
        // Основные переменные игры
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Элементы интерфейса
        const finalScoreElement = document.getElementById('finalScore');
        const finalCoinsElement = document.getElementById('finalCoins');
        const finalDiamondsElement = document.getElementById('finalDiamonds');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const readyScreen = document.getElementById('readyScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const restartButton = document.getElementById('restartButton');
        const toLobbyButton = document.getElementById('toLobbyButton');
        const lobbyStartButton = document.getElementById('lobbyStartButton');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const highScoreValue = document.getElementById('highScoreValue');
        
        // Элементы статистики лобби
        const totalCoinsElement = document.getElementById('totalCoins');
        const totalScoreElement = document.getElementById('totalScore');
        const totalDiamondsElement = document.getElementById('totalDiamonds');
        
        const gameContainer = document.getElementById('gameContainer');

        // Настройки игры с учетом safe area от Telegram
        const gameSettings = {
            baseWidth: 430,
            baseHeight: 932,
            safeAreaTop: telegram.WebApp ? (telegram.WebApp.safeAreaInset?.top || 0) : 0
        };

        // Загрузка изображений
        const images = {
            bird: new Image(),
            pipeTop: new Image(),
            pipeBottom: new Image(),
            background: new Image(),
            scoreBoard: new Image(),
            coin: new Image(),
            coinScoreBoard: new Image(),
            diamond: new Image(),
            diamondScoreBoard: new Image(),
            lobbyBackground: new Image(),
            startButton: new Image(),
            recordScore: new Image()
        };

        // Укажите здесь пути к вашим изображениям
        images.bird.src = 'images/ClassicDuckSkin.png';
        images.pipeTop.src = 'images/PipeDown.png';
        images.pipeBottom.src = 'images/PipeDown.png';
        images.background.src = 'images/Game.png';
        images.scoreBoard.src = 'images/ScoreBoard.png';
        images.coin.src = 'images/Coin.png';
        images.coinScoreBoard.src = 'images/CoinScore.png';
        images.diamond.src = 'images/Emerald.png';
        images.diamondScoreBoard.src = 'images/EmeraldScore.png';
        images.lobbyBackground.src = 'images/Main.png';
        images.startButton.src = 'images/StartBottom.png';
        images.recordScore.src = 'images/RecordScore.png';

        // Глобальные переменные для хранения прогресса
        let totalCoins = 0;
        let totalDiamonds = 0;
        let highScore = 0;
        
        // Параметры текущей игры
        let gameState = 'lobby';
        let score = 0;
        let coinsCount = 0;
        let diamondsCount = 0;
        let frames = 0;
        let pipeCounter = 0;
        let diamondPipeCounter = 0;
        let isTouching = false;
        
        // НОВОЕ: Коэффициенты скорости игры - теперь не зависят от масштаба
        const GAME_SPEED = 3; // Базовая скорость движения объектов

        // Загрузка прогресса из облачного хранилища Telegram
        async function loadProgress() {
            // ... (остается без изменений) ...
        }
        
        // Сохранение прогресса в облачное хранилище Telegram
        async function saveProgress() {
            // ... (остается без изменений) ...
        }
        
        // Обновление статистики в лобби
        function updateLobbyStats() {
            totalCoinsElement.textContent = totalCoins;
            totalScoreElement.textContent = highScore;
            totalDiamondsElement.textContent = totalDiamonds;
        }

        // Тактильная отдача (виброотклик)
        function triggerHapticFeedback(type = 'light') {
            // ... (остается без изменений) ...
        }

        // Параметры птицы
        const bird = {
            x: 80,
            y: 40,
            width: 87,
            height: 75,
            gravity: 0.4,
            lift: -9,
            velocity: 0,
            rotation: 0,
            
            init() {
                this.y = canvas.height / 2;
                this.velocity = 0;
                this.rotation = 0;
            },
            
            draw() {
                // ... (остается без изменений) ...
            },
            
            update() {
                if (gameState !== 'playing') return;
                
                this.velocity += this.gravity;
                this.y += this.velocity;
                
                this.rotation = Math.max(-0.3, Math.min(0.3, this.velocity * 0.03));
                
                // Столкновение с верхней границей контейнера (canvas)
                if (this.y - this.height/2 <= 0) {
                    this.y = 0 + this.height/2;
                    if (gameState === 'playing') {
                        gameOver();
                    }
                }
                
                // Столкновение с нижней границей контейнера (canvas)
                if (this.y + this.height/2 >= canvas.height) {
                    this.y = canvas.height - this.height/2;
                    if (gameState === 'playing') {
                        gameOver();
                    }
                }
            },
            
            flap() {
                this.velocity = this.lift;
                this.rotation = -0.3;
                // Легкая вибрация при взмахе
                triggerHapticFeedback('light');
            }
        };

        // Трубы - ИСПРАВЛЯЕМ СКОРОСТЬ
        const pipes = {
            position: [],
            gap: 250,
            dx: GAME_SPEED, // Используем константу вместо масштабирования
            width: 96,
            pipeHeight: 640,
            
            draw() {
                for (let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    
                    if (images.pipeTop.complete && images.pipeBottom.complete && 
                        images.pipeTop.naturalWidth > 0 && images.pipeBottom.naturalWidth > 0) {
                        // Верхняя труба
                        ctx.save();
                        ctx.translate(p.x + this.width/2, p.y + this.pipeHeight/2);
                        ctx.rotate(Math.PI);
                        ctx.drawImage(images.pipeTop, -this.width/2, -this.pipeHeight/2, this.width, this.pipeHeight);
                        ctx.restore();
                        
                        // Нижняя труба
                        let bottomY = p.y + this.pipeHeight + this.gap;
                        ctx.drawImage(images.pipeBottom, p.x, bottomY, this.width, this.pipeHeight);
                    } else {
                        // Фолбэк
                        ctx.fillStyle = '#75C235';
                        // Верхняя труба
                        ctx.fillRect(p.x, p.y, this.width, this.pipeHeight);
                        
                        // Нижняя труба
                        let bottomY = p.y + this.pipeHeight + this.gap;
                        ctx.fillRect(p.x, bottomY, this.width, canvas.height - bottomY);
                    }
                }
            },
            
            update() {
                if (gameState !== 'playing') return;
                
                if (frames % 100 === 0) {
                    // ИСПРАВЛЕНИЕ: Убираем масштабирование из расчета высоты
                    const skyHeight = 100; // Фиксированная высота неба
                    const groundHeight = 100; // Фиксированная высота земли
                    const playableHeight = canvas.height - skyHeight - groundHeight;
                    const minPipeHeight = 100;
                    const maxPipeHeight = playableHeight - this.gap - minPipeHeight;
                    
                    if (maxPipeHeight > minPipeHeight) {
                        const height = minPipeHeight + Math.random() * (maxPipeHeight - minPipeHeight);
                    
                        this.position.push({
                            x: canvas.width,
                            y: skyHeight - height,
                            width: this.width,
                            height: this.pipeHeight
                        });
                        
                        pipeCounter++;
                        diamondPipeCounter++;
                        
                        // Создание монеток
                        if (pipeCounter >= 5 && Math.random() < 1) {
                            createCoin();
                            pipeCounter = 0;
                        }
                        
                        // Создание алмазов каждые 8 труб с вероятностью 10%
                        if (diamondPipeCounter >= 8 && Math.random() < 1) {
                            createDiamond();
                            diamondPipeCounter = 0;
                        }
                    }
                }
                
                for (let i = this.position.length - 1; i >= 0; i--) {
                    let p = this.position[i];
                    p.x -= this.dx; // Используем фиксированную скорость
                    
                    if (this.collision(bird, p)) {
                        gameOver();
                    }
                    
                    if (p.x + this.width <= 0) {
                        this.position.splice(i, 1);
                        score++;
                    }
                }
            },
            
            collision(bird, pipe) {
                // ... (остается без изменений) ...
            },
            
            reset() {
                this.position = [];
            }
        };

        // Монетки - ИСПРАВЛЯЕМ СКОРОСТЬ
        const coinManager = {
            items: [],
            width: 28,
            height: 28,
            dx: GAME_SPEED, // Используем константу вместо масштабирования
            animationSpeed: 0.05,
            
            draw() {
                // ... (остается без изменений) ...
            },
            
            update() {
                if (gameState !== 'playing') return;
                
                for (let i = this.items.length - 1; i >= 0; i--) {
                    let coin = this.items[i];
                    coin.x -= this.dx; // Используем фиксированную скорость
                    
                    // Анимация движения вверх-вниз
                    coin.animationTime += this.animationSpeed;
                    coin.y = coin.baseY + Math.sin(coin.animationTime) * 10;
                    
                    if (this.collection(bird, coin)) {
                        this.items.splice(i, 1);
                        coinsCount++;
                        // Вибрация при сборе монеты
                        triggerHapticFeedback('light');
                    }
                    
                    if (coin.x + this.width <= 0) {
                        this.items.splice(i, 1);
                    }
                }
            },
            
            collection(bird, coin) {
                // ... (остается без изменений) ...
            },
            
            reset() {
                this.items = [];
            }
        };

        // Алмазы - ИСПРАВЛЯЕМ СКОРОСТЬ
        const diamondManager = {
            items: [],
            width: 28,
            height: 28,
            dx: GAME_SPEED, // Используем константу вместо масштабирования
            animationSpeed: 0.05,
            
            draw() {
                // ... (остается без изменений) ...
            },
            
            update() {
                if (gameState !== 'playing') return;
                
                for (let i = this.items.length - 1; i >= 0; i--) {
                    let diamond = this.items[i];
                    diamond.x -= this.dx; // Используем фиксированную скорость
                    
                    // Анимация движения вверх-вниз
                    diamond.animationTime += this.animationSpeed;
                    diamond.y = diamond.baseY + Math.sin(diamond.animationTime) * 10;
                    
                    if (this.collection(bird, diamond)) {
                        this.items.splice(i, 1);
                        diamondsCount++;
                        // Более сильная вибрация при сборе алмаза
                        triggerHapticFeedback('medium');
                    }
                    
                    if (diamond.x + this.width <= 0) {
                        this.items.splice(i, 1);
                    }
                }
            },
            
            collection(bird, diamond) {
                // ... (остается без изменений) ...
            },
            
            reset() {
                this.items = [];
            }
        };

        // Функция создания монетки
        function createCoin() {
            if (pipes.position.length > 0) {
                const lastPipe = pipes.position[pipes.position.length - 1];
                const coinX = lastPipe.x + pipes.width + 50; // Убираем масштабирование
                const baseY = Math.max(0, Math.min(canvas.height - coinManager.height, 
                    lastPipe.y + pipes.pipeHeight + pipes.gap/2 - coinManager.height/2));
                
                coinManager.items.push({ 
                    x: coinX, 
                    y: baseY,
                    baseY: baseY,
                    animationTime: Math.random() * Math.PI * 2
                });
            }
        }

        // Функция создания алмаза
        function createDiamond() {
            if (pipes.position.length > 0) {
                const lastPipe = pipes.position[pipes.position.length - 1];
                const diamondX = lastPipe.x + pipes.width + 50; // Убираем масштабирование
                const baseY = Math.max(0, Math.min(canvas.height - diamondManager.height,
                    lastPipe.y + pipes.pipeHeight + pipes.gap/2 - diamondManager.height/2));
                
                diamondManager.items.push({ 
                    x: diamondX, 
                    y: baseY,
                    baseY: baseY,
                    animationTime: Math.random() * Math.PI * 2
                });
            }
        }

        // Фон
        const background = {
            draw() {
                if (images.background.complete && images.background.naturalWidth > 0) {
                    ctx.drawImage(images.background, 0, 0, canvas.width, canvas.height);
                } else {
                    ctx.fillStyle = '#87CEEB';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            }
        };

        // Счетчик очков - ИСПРАВЛЯЕМ ПОЗИЦИОНИРОВАНИЕ
        const scoreBoard = {
            x: 146,
            y: 120,
            width: 138,
            height: 36,
            
            draw() {
                // ИСПРАВЛЕНИЕ: Фиксированная позиция без масштабирования
                const currentY = this.y;
                
                if (images.scoreBoard.complete && images.scoreBoard.naturalWidth > 0) {
                    // Рисуем в оригинальном размере
                    ctx.drawImage(images.scoreBoard, this.x, currentY, this.width, this.height);
                } else {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(this.x, currentY, this.width, this.height);
                    
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(this.x, currentY, this.width, this.height);
                }
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 30px "PIXY", Arial, sans-serif'; // Фиксированный размер шрифта
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(score.toString(), this.x + this.width/2, currentY + this.height/2);
            }
        };

        // Счетчик монеток - ИСПРАВЛЯЕМ ПОЗИЦИОНИРОВАНИЕ
        const coinScoreBoard = {
            x: 27,
            y: 120,
            width: 82,
            height: 36,
            textX: 76,
            textY: 138,
            
            draw() {
                // ИСПРАВЛЕНИЕ: Фиксированная позиция без масштабирования
                const currentY = this.y;
                const currentTextY = this.textY;
                
                if (images.coinScoreBoard.complete && images.coinScoreBoard.naturalWidth > 0) {
                    ctx.drawImage(images.coinScoreBoard, this.x, currentY, this.width, this.height);
                } else {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(this.x, currentY, this.width, this.height);
                    
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(this.x, currentY, this.width, this.height);
                }
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 25px "PIXY", Arial, sans-serif'; // Фиксированный размер шрифта
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(coinsCount.toString(), this.textX, currentTextY);
            }
        };

        // Счетчик алмазов - ИСПРАВЛЯЕМ ПОЗИЦИОНИРОВАНИЕ
        const diamondScoreBoard = {
            x: 316,
            y: 120,
            width: 82,
            height: 36,
            textX: 340,
            textY: 138,
            
            draw() {
                // ИСПРАВЛЕНИЕ: Фиксированная позиция без масштабирования
                const currentY = this.y;
                const currentTextY = this.textY;
                
                if (images.diamondScoreBoard.complete && images.diamondScoreBoard.naturalWidth > 0) {
                    ctx.drawImage(images.diamondScoreBoard, this.x, currentY, this.width, this.height);
                } else {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(this.x, currentY, this.width, this.height);
                    
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(this.x, currentY, this.width, this.height);
                }
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 25px "PIXY", Arial, sans-serif'; // Фиксированный размер шрифта
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(diamondsCount.toString(), this.textX, currentTextY);
            }
        };

        // Функции игры
        async function gameOver() {
            // ... (остается без изменений) ...
        }

        async function resetGame() {
            // ... (остается без изменений) ...
        }

        function showLobby() {
            gameState = 'lobby';
            hideAllScreens();
            lobbyScreen.style.display = 'flex';
            updateLobbyStats();
            
            // Устанавливаем фон лобби
            if (images.lobbyBackground.complete && images.lobbyBackground.naturalWidth > 0) {
                lobbyScreen.style.backgroundImage = `url('${images.lobbyBackground.src}')`;
                lobbyScreen.style.backgroundSize = 'cover';
                lobbyScreen.style.backgroundPosition = 'center';
                lobbyScreen.style.backgroundRepeat = 'no-repeat';
            }
        }

        function startPlaying() {
            gameState = 'playing';
            hideAllScreens();
            bird.flap();
        }

        function hideAllScreens() {
            lobbyScreen.style.display = 'none';
            readyScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            background.draw();
            pipes.draw();
            coinManager.draw();
            diamondManager.draw();
            
            scoreBoard.draw();
            coinScoreBoard.draw();
            diamondScoreBoard.draw();
            bird.draw();
        }

        function update() {
            if (gameState !== 'playing') return;
            
            frames++;
            bird.update();
            pipes.update();
            coinManager.update();
            diamondManager.update();
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Убираем функцию scaleGameObjects полностью - больше не нужна
        
        // Масштабирование элементов лобби
        function scaleLobby() {
            // Получаем размеры контейнера
            const containerWidth = gameContainer.clientWidth;
            const containerHeight = gameContainer.clientHeight;
            
            // Рассчитываем масштаб только для лобби
            const scaleX = containerWidth / gameSettings.baseWidth;
            const scaleY = containerHeight / gameSettings.baseHeight;
            const scale = Math.min(scaleX, scaleY);
            
            // Масштабируем размеры птицы в лобби
            const lobbyDuck = document.getElementById('lobbyDuck');
            if (lobbyDuck) {
                lobbyDuck.style.width = `${261 * scale}px`;  // 87 * 3
                lobbyDuck.style.height = `${225 * scale}px`; // 75 * 3
                lobbyDuck.style.marginBottom = `${250 * scale}px`;
            }
            
            // Масштабируем кнопку старта
            const startButton = document.getElementById('lobbyStartButton');
            if (startButton) {
                startButton.style.width = `${200 * scale}px`;
                startButton.style.height = `${80 * scale}px`;
                startButton.style.bottom = `${120 * scale}px`;
            }
            
            // Масштабируем статистику
            const statImages = document.querySelectorAll('.stat-image');
            statImages.forEach(img => {
                img.style.width = `${40 * scale}px`;
                img.style.height = `${40 * scale}px`;
            });
            
            const statValues = document.querySelectorAll('.stat-value');
            statValues.forEach(stat => {
                stat.style.fontSize = `${28 * scale}px`;
            });
        }

        // Динамический расчет размеров
        function resizeCanvas() {
            const container = gameContainer;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Устанавливаем размеры canvas равными размерам контейнера
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            // Обновляем базовые значения для лобби
            gameSettings.baseWidth = 430;
            gameSettings.baseHeight = 932;
            
            // Масштабируем элементы лобби
            scaleLobby();
            
            // Принудительно перерисовываем экран
            if (gameState === 'ready' || gameState === 'lobby') {
                draw();
            }
        }

        // Блокировка ориентации экрана
        function lockOrientation() {
            // ... (остается без изменений) ...
        }

        // Обработчик для начала игры на экране ожидания
        function handleReadyScreenClick(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (gameState === 'ready') {
                startPlaying();
            }
            return false;
        }

        // Обработчик для управления птицей во время игры
        function handleGameInput(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (gameState === 'playing') {
                bird.flap();
            }
            return false;
        }

        // Обработчик изменения размера окна
        function handleResize() {
            resizeCanvas();
            
            // Переинициализируем птицу при изменении размера
            bird.init();
            
            // Принудительно перерисовываем экран
            if (gameState === 'ready' || gameState === 'lobby') {
                draw();
            }
        }

        // Инициализация
        async function init() {
            // Устанавливаем начальный размер
            resizeCanvas();
            
            // Блокируем ориентацию экрана
            lockOrientation();
            
            // Добавляем обработчики событий для экрана ожидания
            readyScreen.addEventListener('touchstart', handleReadyScreenClick, { passive: false });
            readyScreen.addEventListener('mousedown', handleReadyScreenClick, { passive: false });
            readyScreen.addEventListener('click', handleReadyScreenClick, { passive: false });
            
            // Добавляем обработчики для игрового поля (canvas) для управления птицей
            canvas.addEventListener('touchstart', handleGameInput, { passive: false });
            canvas.addEventListener('mousedown', handleGameInput, { passive: false });
            
            // Обработчики для кнопок лобби
            lobbyStartButton.addEventListener('click', async function(e) {
                e.stopPropagation();
                await resetGame();
            }, { passive: true });
            
            // Обработчики для экрана окончания игры
            restartButton.addEventListener('click', async function(e) {
                e.stopPropagation();
                await resetGame();
            }, { passive: true });
            
            toLobbyButton.addEventListener('click', function(e) {
                e.stopPropagation();
                showLobby();
            }, { passive: true });
            
            // Обработчики изменения размера
            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', handleResize);
            
            // Предотвращаем контекстное меню на длинное нажатие
            gameContainer.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Предотвращаем масштабирование на iOS
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            // Инициализируем птицу
            bird.init();
            
            // Загружаем прогресс
            await loadProgress();
            
            // Показываем лобби
            showLobby();
            
            // Запускаем игровой цикл
            gameLoop();
            
            // Дополнительные настройки для Telegram
            if (telegram.WebApp) {
                // Проверяем, что приложение расширено на весь экран
                setTimeout(() => {
                    if (!telegram.WebApp.isExpanded) {
                        telegram.WebApp.expand();
                    }
                    
                    // Принудительно обновляем размеры через секунду после загрузки
                    setTimeout(() => {
                        resizeCanvas();
                    }, 1000);
                }, 500);
            }
        }

        // Запуск игры
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
